const cds = require('../../../cds')
const { toODataResult } = require('../utils/event')

/**
 * Provide localized metadata handler.
 *
 * @param {Object} service
 * @param {Object} options
 * @return {Function}
 */
const metadata = (service, options) => {
  return async (req, res, next) => {
    const locale = res.getContract().getLocale()

    const tenantId = req._inRequest.authInfo ? req._inRequest.authInfo.identityZone : undefined

    if (tenantId && cds.mtx && service._isExtended) {
      try {
        if (!service._edmx) {
          service._edmx = await cds.mtx.getEdmx(tenantId, service.name, locale)
        }
        return next(null, toODataResult(service._edmx))
      } catch (err) {
        return next({ statusCode: 500 })
      }
    }

    if (!service._edmx) {
      service._edmx = cds.compile.to.edmx(service._csn, Object.assign({ version: 'v4' }, options))
    }

    const localized = cds.localize(service._csn, locale, service._edmx)
    return next(null, toODataResult(localized))
  }
}

module.exports = metadata
